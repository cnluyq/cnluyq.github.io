
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { 
            position: absolute; left: 0; top: 0; opacity: 0; 
            width: 100%; height: 100%; cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-blue-600">问题管理系统</h1>
            <p class="text-gray-600">记录和追踪问题解决方案</p>
        </header>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <div class="relative w-64">
                    <input type="text" id="searchInput" placeholder="搜索关键词..." 
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                </div>
                <button id="addBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-plus mr-2"></i>添加记录
                </button>
                <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-file-export mr-2"></i>导出JSON
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left">No.</th>
                            <th class="py-3 px-4 text-left">关键词</th>
                            <th class="py-3 px-4 text-left">问题标题</th>
                            <th class="py-3 px-4 text-left">问题描述</th>
                            <th class="py-3 px-4 text-left">根本原因</th>
                            <th class="py-3 px-4 text-left">解决方案</th>
                            <th class="py-3 px-4 text-left">其他</th>
                            <th class="py-3 px-4 text-left">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <!-- 数据将通过JS动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-screen overflow-y-auto fade-in">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-semibold" id="modalTitle">添加新记录</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="dataForm" class="p-6">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-gray-700 mb-2" for="keyWords">关键词</label>
                        <input type="text" id="keyWords" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2" for="problemTitle">问题标题</label>
                        <input type="text" id="problemTitle" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 mb-2" for="problemDesc">问题描述</label>
                        <textarea id="problemDesc" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 mb-2" for="rootCause">根本原因</label>
                        <textarea id="rootCause" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <div class="file-input-wrapper mt-2">
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-paperclip mr-1"></i>添加附件
                            </button>
                            <input type="file" id="rootCauseFile" class="hidden">
                        </div>
                        <div id="rootCauseFiles" class="mt-2"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 mb-2" for="solutions">解决方案</label>
                        <textarea id="solutions" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <div class="file-input-wrapper mt-2">
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-paperclip mr-1"></i>添加附件
                            </button>
                            <input type="file" id="solutionsFile" class="hidden">
                        </div>
                        <div id="solutionsFiles" class="mt-2"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 mb-2" for="others">其他</label>
                        <textarea id="others" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <div class="file-input-wrapper mt-2">
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-paperclip mr-1"></i>添加附件
                            </button>
                            <input type="file" id="othersFile" class="hidden">
                        </div>
                        <div id="othersFiles" class="mt-2"></div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">取消</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 文件预览模态框 -->
    <div id="fileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-screen overflow-y-auto fade-in">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-semibold" id="fileModalTitle">文件预览</h3>
                <button id="closeFileModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="filePreviewContent" class="text-center">
                    <!-- 文件预览内容将在这里显示 -->
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="downloadFileBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>下载文件
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据
            let records = JSON.parse(localStorage.getItem('problemRecords')) || [];
            let currentFile = null;
            
            // DOM元素
            const dataTable = document.getElementById('dataTable');
            const searchInput = document.getElementById('searchInput');
            const addBtn = document.getElementById('addBtn');
            const exportBtn = document.getElementById('exportBtn');
            const modal = document.getElementById('modal');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const dataForm = document.getElementById('dataForm');
            const fileModal = document.getElementById('fileModal');
            const closeFileModal = document.getElementById('closeFileModal');
            const downloadFileBtn = document.getElementById('downloadFileBtn');
            
            // 渲染表格
            function renderTable(data = records) {
                dataTable.innerHTML = '';
                data.forEach((record, index) => {
                    const tr = document.createElement('tr');
                    tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-4">${index + 1}</td>
                        <td class="py-3 px-4">${record.keyWords}</td>
                        <td class="py-3 px-4">${record.problemTitle}</td>
                        <td class="py-3 px-4 max-w-xs truncate">${record.problemDesc}</td>
                        <td class="py-3 px-4 max-w-xs truncate">${record.rootCause.text}
                            ${record.rootCause.files && record.rootCause.files.length > 0 ? 
                                `<span class="text-blue-500 text-sm">(${record.rootCause.files.length}个附件)</span>` : ''}
                        </td>
                        <td class="py-3 px-4 max-w-xs truncate">${record.solutions.text}
                            ${record.solutions.files && record.solutions.files.length > 0 ? 
                                `<span class="text-blue-500 text-sm">(${record.solutions.files.length}个附件)</span>` : ''}
                        </td>
                        <td class="py-3 px-4 max-w-xs truncate">${record.others.text}
                            ${record.others.files && record.others.files.length > 0 ? 
                                `<span class="text-blue-500 text-sm">(${record.others.files.length}个附件)</span>` : ''}
                        </td>
                        <td class="py-3 px-4">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${record.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${record.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    dataTable.appendChild(tr);
                });
                
                // 添加编辑和删除事件
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        editRecord(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        deleteRecord(id);
                    });
                });
            }
            
            // 添加新记录
            function addRecord() {
                document.getElementById('modalTitle').textContent = '添加新记录';
                document.getElementById('editId').value = '';
                dataForm.reset();
                document.getElementById('rootCauseFiles').innerHTML = '';
                document.getElementById('solutionsFiles').innerHTML = '';
                document.getElementById('othersFiles').innerHTML = '';
                modal.classList.remove('hidden');
            }
            
            // 编辑记录
            function editRecord(id) {
                const record = records.find(r => r.id === id);
                if (!record) return;
                
                document.getElementById('modalTitle').textContent = '编辑记录';
                document.getElementById('editId').value = record.id;
                document.getElementById('keyWords').value = record.keyWords;
                document.getElementById('problemTitle').value = record.problemTitle;
                document.getElementById('problemDesc').value = record.problemDesc;
                document.getElementById('rootCause').value = record.rootCause.text;
                document.getElementById('solutions').value = record.solutions.text;
                document.getElementById('others').value = record.others.text;
                
                // 显示已有附件
                renderAttachments('rootCauseFiles', record.rootCause.files);
                renderAttachments('solutionsFiles', record.solutions.files);
                renderAttachments('othersFiles', record.others.files);
                
                modal.classList.remove('hidden');
            }
            
            // 渲染附件
            function renderAttachments(containerId, files) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                if (files && files.length > 0) {
                    files.forEach((file, index) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between bg-gray-100 p-2 rounded mb-1';
                        div.innerHTML = `
                            <span class="text-sm truncate">${file.name}</span>
                            <div>
                                <button class="view-file-btn text-blue-500 hover:text-blue-700 mr-2" data-file='${JSON.stringify(file)}'>
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="remove-file-btn text-red-500 hover:text-red-700" data-index="${index}" data-container="${containerId}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                    
                    // 添加查看和删除附件事件
                    container.querySelectorAll('.view-file-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const file = JSON.parse(e.currentTarget.getAttribute('data-file'));
                            previewFile(file);
                        });
                    });
                    
                    container.querySelectorAll('.remove-file-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = e.currentTarget.getAttribute('data-index');
                            const containerId = e.currentTarget.getAttribute('data-container');
                            removeFile(containerId, index);
                        });
                    });
                }
            }
            
            // 预览文件
            function previewFile(file) {
                currentFile = file;
                const previewContent = document.getElementById('filePreviewContent');
                previewContent.innerHTML = '';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = file.data;
                    img.alt = file.name;
                    img.className = 'max-w-full max-h-96 mx-auto';
                    previewContent.appendChild(img);
                } else if (file.type === 'application/pdf') {
                    const iframe = document.createElement('iframe');
                    iframe.src = file.data;
                    iframe.className = 'w-full h-96';
                    previewContent.appendChild(iframe);
                } else {
                    previewContent.innerHTML = `
                        <div class="p-4">
                            <i class="fas fa-file text-5xl text-gray-400 mb-2"></i>
                            <p class="text-lg font-semibold">${file.name}</p>
                            <p class="text-gray-500">不支持在线预览，请下载后查看</p>
                        </div>
                    `;
                }
                
                fileModal.classList.remove('hidden');
            }
            
            // 删除文件
            function removeFile(containerId, index) {
                const container = document.getElementById(containerId);
                const field = containerId.replace('Files', '');
                const id = document.getElementById('editId').value;
                
                if (id) {
                    // 编辑模式下，从记录中删除文件
                    const record = records.find(r => r.id === id);
                    if (record) {
                        record[field].files.splice(index, 1);
                        localStorage.setItem('problemRecords', JSON.stringify(records));
                    }
                }
                
                // 从DOM中删除文件显示
                container.children[index].remove();
            }
            
            // 删除记录
            function deleteRecord(id) {
                if (confirm('确定要删除这条记录吗？')) {
                    records = records.filter(r => r.id !== id);
                    localStorage.setItem('problemRecords', JSON.stringify(records));
                    renderTable();
                }
            }
            
            // 保存记录
            function saveRecord(e) {
                e.preventDefault();
                
                const id = document.getElementById('editId').value;
                const record = {
                    id: id || Date.now().toString(),
                    keyWords: document.getElementById